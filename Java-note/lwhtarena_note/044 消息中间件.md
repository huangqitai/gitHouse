# 消息中间件

> 开源消息中间件产品

- Kafka
- RabbitMQ
- RocketMQ


##### Kafka
Kafka是LinkedIn开源的分布式发布-订阅消息系统，目前归属于Apache定级项目。Kafka主要特点是基于Pull的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集和传输。0.8版本开始支持复制，不支持事务，对消息的重复、丢失、错误没有严格要求，适合产生大量数据的互联网服务的数据收集业务。

**吞吐量：Kafka的吞吐量高达17.3w/s**

&emsp;&emsp;不愧是高吞吐量消息中间件的行业老大。这主要取决于它的队列模式保证了写磁盘的过程是线性IO。此时broker磁盘IO已达瓶颈。


##### RabbitMQ

![](./mq/001.jpg)

RabbitMQ是使用Erlang语言开发的开源消息队列系统，基于AMQP协议来实现。AMQP的主要特征是面向消息、队列、路由（包括点对点和发布/订阅）、可靠性、安全。AMQP协议更多用在企业系统内，对数据一致性、稳定性和可靠性要求很高的场景，对性能和吞吐量的要求还在其次。（实现了Broker构架，这意味着消息在发送给客户端时先在中心队列排队。对`路由，负载均衡或者数据持久化`都有很好的支持。）

**吞吐量：RabbitMQ吞吐量5.95w/s**

&emsp;&emsp;CPU资源消耗较高。它支持AMQP协议，实现非常重量级，为了保证消息的可靠性在吞吐量上做了取舍。我们还做了RabbitMQ在消息持久化场景下的性能测试，吞吐量在2.6w/s左右。结合erlang语言本身的并发优势，性能较好，但是不利于做二次开发和维护

##### RocketMQ

RocketMQ是阿里开源的消息中间件，它是纯Java开发，具有高吞吐量、高可用性、适合大规模分布式系统应用的特点。RocketMQ思路起源于Kafka，但并不是Kafka的一个Copy，它对消息的可靠传输及事务性做了优化，目前在阿里集团被广泛应用于交易、充值、流计算、消息推送、日志流式处理、binglog分发等场景。

**吞吐量：RocketMQ吞吐量在11.6w/s**

&emsp;&emsp;磁盘IO %util已接近100%。RocketMQ的消息写入内存后即返回ack，由单独的线程专门做刷盘的操作，<font size=3 gace="黑体" color=red>所有的消息均是顺序写文件。</font>

> 测试结论

<font face="黑体" size=4 color=red>  在服务端处理同步发送的性能上，Kafka > RocketMQ > RabbitMQ。</font>

[详见报告](https://yq.aliyun.com/articles/25385)

##### 阿里云MNS

阿里云消息服务（Message Service，原MQS）是阿里云唯一商用的消息中间件服务。与传统的消息中间件不同，消息服务一开始就是基于阿里云自主研发的飞天分布式系统来设计和实现，具有大规模，高可靠、高并发访问和超强消息堆积能力的特点。<font size=3 color=red>消息服务API采用HTTP RESTful标准，接入方便，跨网络能力强</font>；已全面接入资源访问控制服务（RAM）、专有网络（VPC），支持各种安全访问控制；接入云监控，提供完善的监控及报警机制。消息服务提供丰富的SDK、解决方案、最佳实践和7x24小时的技术支持，帮助应用开发者在应用组件之间自由地传递数据和构建松耦合、分布式、高可用系统。

#####  ZeroMQ

ZeroMQ :  扩展性好，开发比较灵活，采用C语言实现，实际上他只是一个socket库的重新封装，如果我们做为消息队列使用，需要开发大量的代码

#####  ActiveMQ			

 ActiveMQ: 历史悠久的开源项目，已经在很多产品中得到应用，实现了JMS1.1规范，可以和spring-jms轻松融合，实现了多种协议，不够轻巧（源代码比RocketMQ多）.，支持持久化到数据库，对队列数较多的情况支持不好，不过我们的项目中并不会建很多的队列.




### AMQP协议

**AMQP**，即Advanced Message Queuing Protocol，高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计

AMQP的主要特征是面向消息、队列、路由（包括点对点和发布/订阅）、可靠性、安全。

AMQP在消息提供者和客户端的行为进行了强制规定，使得不同卖商之间真正实现了互操作能力。

JMS是早期消息中间件进行标准化的一个尝试，它仅仅是在API级进行了规范，离创建互操作能力还差很远。

与JMS不同，AMQP是一个Wire级的协议，它描述了在网络上传输的数据的格式，以字节为流。因此任何遵守此数据格式的工具，其创建和解释消息，都能与其他兼容工具进行互操作。

> 实现AMQP协议的开源

- 1）OpenAMQ
AMQP的开源实现，用`C语言`编写，运行于`Linux`、AIX、Solaris、Windows、OpenVMS。

- 2）Apache Qpid
Apache的开源项目，支持C++、Ruby、Java、JMS、Python和.NET。

- 3）Redhat Enterprise MRG
实现了AMQP的最新版本0-10，提供了丰富的特征集，比如完全管理、联合、Active-Active集群，有Web控制台，还有许多企业级特征，客户端支持C++、Ruby、Java、JMS、python和.NET。

- 4）RabbitMQ
一个独立的开源实现，服务器端用Erlang语言编写，支持多种客户端，如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等，支持AJAX。RabbitMQ发布在Ubuntu、FreeBSD平台。

- 5）AMQP Infrastructure
linux下，包括Broker、管理工具、Agent和客户端。

- 6）ØMQ
一个高性能的消息平台，在分布式消息网络可作为兼容AMQP的Broker节点，绑定了多种语言，包括Python、C、C++、Lisp、Ruby等。

- 7）Zyre
是一个Broker，实现了RestMS协议和AMQP协议，提供了RESTful HTTP访问网络AMQP的能力。


> 目前比较活跃的几种MQ中间件产品的对比如下：（仅统计开源的项目）

 
属性 |ActiveMQ | RabbitMQ | RocketMq | ZeroMQ
------------ | ------------|------------ | ------------| ------------
关注度 | 高 | 高	| 中 |中
成熟度|  成熟|	成熟|	比较成熟|不成熟
所属社区/公司	|Apache	| Mozilla Public License|Alibaba |没有  
社区活跃度 | 	高|	高	|中|	低
文档  |	多|	多	|中|	中
特点  |功能齐全，被大量开源项目使用 |由于Erlang 语言的并发能力，性能很好 | 各个环节分布式扩展设计，主从 HA；支持上万个队列；多种消费模式；性能很好|低延时，高性能，最高 43万条消息每秒  
授权方式 | 开源|开源|开源|开源
开发语言  |Java|Erlang | Java |C
支持的协议|OpenWire、STOMP、REST、XMPP、AMQP|AMQP |自己定义的一套(社区提供JMS--不成熟)|TCP、UDP
客户端支持语言|Java、C、C++、Python、PHP、Perl、.net 等 |	Java、C、C++、Python、 PHP、Perl 等|Java、C++（不成熟）|python、 java、 php、.net 等
持久化 |内存、文件、数据库|内存、文件|	磁盘文件|在消息发送端保存
事务  	|支持	|不支持	|支持	|不支持
集群  	|支持	|支持	|支持	|不支持
负载均衡	|支持	|支持	|支持	|不支持
管理界面 |一般	|好	    |无社区有 web console实现	|无
部署方式 |独立、嵌入|	独立 |独立	|独立
评价| **优点：** 成熟的产品，已经在很多公司得到应用（非大规模场景）。有较多的文档。各种协议支持较好，有多重语言的成熟的客户端； **缺点：** 根据其他用户反馈，会出莫名其妙的问题，切会丢失消息。 其重心放到activemq6.0 产品—apollo 上去了，目前社区不活跃，且对 5.x 维护较少；Activemq 不适合用于上千个队列的应用场景	| **优点：** 由于erlang语言的特性，mq 性能较好；管理界面较丰富，在互联网公司也有较大规模的应用；支持amqp系诶，有多中语言且支持 amqp 的客户端可用 **缺点：** erlang语言难度较大。集群不支持动态扩展。| **优点：** 模型简单，接口易用（JMS   的接口很多场合并不太实用）。在阿里大规模应用。目前支付宝中的余额宝等新兴产品均使用rocketmq。集群规模大概在50 台左右，单日处理消息上百亿；性能非常好，可以大量堆积消息在broker中；支持多种消费，包括集群消费、广播消费等。开发度较活跃，版本更新很快。  ** 缺点：**  没有在 mq 核心中去实现JMS 等接口。 | 暂无	 
 




